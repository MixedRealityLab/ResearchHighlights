<project name="ResearchHighlights" default="common" basedir=".">

	<description>
		Build file for the Research Highlights website
	</description>

	<property name="dist.dir" location="dist" />
	<property name="lib.dir" location="lib" />
	<property name="src.dir" location="src/common"/>
	<property name="secret.dir" location="src/secret"/>
	<property name="highlights.dir" location="src/highlights" />
	<property name="submission.dir" location="src/submission" />
	
	<path id="project.classpath">
		<fileset dir="${lib.dir}">
			<include name="*.jar"/>
		</fileset>
	</path>

	<taskdef name="jscomp" classname="com.google.javascript.jscomp.ant.CompileTask" classpathref="project.classpath"/>
	<taskdef name="cscomp" classname="in.parambir.ant.tasks.CompressTask" classpathref="project.classpath"/>	

	<taskdef resource="yuicompressor.tasks" classpathref="project.classpath"/>	
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${lib.dir}/ant-contrib.jar"/>
		</classpath>
	</taskdef>

 	<target name="clean" description="Remove built and temporary files" >
		<echo message="Removing previous build" />
		<delete dir="${dist.dir}"/>
	</target>

	<target name="common" depends="clean" description="Create the website framework">
		<tstamp/>

		<echo message="Creating ${dist.dir}" />
		<mkdir dir="${dist.dir}"/>

		<echo message="Copying sources from ${src.dir} to ${dist.dir}" />
		<copy todir="${dist.dir}" >  
        	<fileset dir="${src.dir}" includes="**"/>  
		</copy>

		<echo message="Copying sources from ${secret.dir} to ${dist.dir}" />
		<copy todir="${dist.dir}" overwrite="true">  
        	<fileset dir="${secret.dir}" includes="**"/>  
		</copy>
	</target>

	<target name="submission" depends="common" description="Create submission website">
		<echo message="Copying sources from ${submission.dir} to ${dist.dir}" />
		<copy todir="${dist.dir}" overwrite="true">  
        	<fileset dir="${submission.dir}" includes="**"/>  
		</copy>
	</target>

	<target name="highlights" depends="common" description="Create highlights website">
		<echo message="Copying sources from ${highlights.dir} to ${dist.dir}" />
		<copy todir="${dist.dir}" overwrite="true">  
        	<fileset dir="${highlights.dir}" includes="**"/>  
		</copy>
	</target>

	<target name="compress" description="Compress JavaScript and CSS files">
		<foreach target="compress-js" param="foreach.file">
            <path>
                <fileset dir="${dist.dir}" casesensitive="yes">
                    <include name="**/*.js"/>
                </fileset>
            </path>
        </foreach>

		<foreach target="compress-css" param="foreach.file">
            <path>
                <fileset dir="${dist.dir}" casesensitive="yes">
                    <include name="**/*.css"/>
                </fileset>
            </path>
        </foreach>
	</target>

	<target name="compress-js" description="Compress JavaScript files">
		<basename property="file.js" file="${foreach.file}"/>

		<script language="javascript"><![CDATA[

		fullPath = project.getProperty("foreach.file");
		fileOnly = project.getProperty("file.js");
		pathOnly = fullPath.substring(0, fullPath.indexOf(fileOnly));
		project.setProperty("directory",pathOnly);

		]]></script>

		<jscomp compilationLevel="simple" warning="quiet"  debug="false" output="${foreach.file}">
			<sources dir="${directory}">
		    	<file name="${file.js}" />
			</sources>
		</jscomp>
	</target>

	<target name="compress-css" description="Compress CSS files">
		<basename property="file.css" file="${foreach.file}"/>

		<script language="javascript"><![CDATA[
		fullPath = project.getProperty("foreach.file");
		fileOnly = project.getProperty("file.css");
		pathOnly = fullPath.substring(0, fullPath.indexOf(fileOnly));
		project.setProperty("directory",pathOnly);
		]]></script>

		<cscomp todir="${directory}">
			<fileset dir="${directory}">
				<include name="${file.css}"/>
			</fileset>
			<mapper type="glob" from="*.css" to="*.css"/>
		</cscomp>
	</target>

</project>